name: Android Emulator VNC Remote Access

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'
      android_version:
        description: 'Android Version'
        required: false
        default: '11.0'
        type: choice
        options:
        - '9.0'
        - '10.0'
        - '11.0'
        - '12.0'

jobs:
  Android-VNC:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Initialize System
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget curl tar unzip
          
      - name: Install VNC Server and Display
        run: |
          sudo apt-get install -y -qq x11vnc xvfb fluxbox
          
      - name: Install Android SDK Tools
        run: |
          mkdir -p $HOME/android-sdk/cmdline-tools
          cd $HOME/android-sdk/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          mv cmdline-tools latest
          
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator
          
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
          
      - name: Setup Android Emulator
        run: |
          yes | sdkmanager --licenses || true
          
          case "${{ github.event.inputs.android_version }}" in
            "9.0") API_LEVEL=28 ;;
            "10.0") API_LEVEL=29 ;;
            "11.0") API_LEVEL=30 ;;
            "12.0") API_LEVEL=31 ;;
            *) API_LEVEL=30 ;;
          esac
          
          echo "Installing Android API Level: $API_LEVEL"
          sdkmanager "system-images;android-${API_LEVEL};google_apis;x86_64"
          sdkmanager "platform-tools" "emulator"
          
          echo "no" | avdmanager create avd \
            -n android_emulator \
            -k "system-images;android-${API_LEVEL};google_apis;x86_64" \
            -d "pixel_5"
          
      - name: Start VNC Server
        run: |
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          export DISPLAY=:99
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
          fluxbox &
          sleep 2
          
          x11vnc -display :99 -forever -shared -rfbport 5900 -passwd 123456 -noxdamage -bg
          sleep 3
          
      - name: Start Android Emulator
        run: |
          export DISPLAY=:99
          
          emulator -avd android_emulator \
            -no-snapshot-save \
            -no-audio \
            -gpu swiftshader_indirect \
            -camera-back none \
            -camera-front none \
            -memory 4096 \
            -cores 2 \
            -no-window \
            -no-boot-anim &
          
          echo "Waiting for Android Emulator to boot..."
          adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done; input keyevent 82'
          
          echo "Android Emulator is ready!"
          
      - name: Setup Remote Access Tunnel
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          
          ./cloudflared tunnel --url tcp://localhost:5900 > cloudflared.log 2>&1 &
          
          sleep 10
          
          TUNNEL_URL=$(grep -o 'https://[a-zA-Z0-9-]*\.trycloudflare\.com' cloudflared.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "Failed to get tunnel URL. Trying alternative method..."
            sleep 5
            TUNNEL_URL=$(grep -o 'https://[a-zA-Z0-9-]*\.trycloudflare\.com' cloudflared.log | head -n 1)
          fi
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "ERROR: Could not establish tunnel"
            cat cloudflared.log
            exit 1
          fi
          
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo "$TUNNEL_URL" > tunnel_url.txt
          
      - name: Display Connection Information
        run: |
          TUNNEL_URL=$(cat tunnel_url.txt)
          ANDROID_VERSION=$(adb shell getprop ro.build.version.release | tr -d '\r')
          
          echo ""
          echo "═══════════════════════════════════════════════════════════════════"
          echo "                ANDROID EMULATOR VNC - READY                       "
          echo "═══════════════════════════════════════════════════════════════════"
          echo ""
          echo "VNC CONNECTION INFO:"
          echo "-------------------------------------------------------------------"
          echo "Tunnel URL  : $TUNNEL_URL"
          echo "Password    : 123456"
          echo ""
          echo "DEVICE INFO:"
          echo "-------------------------------------------------------------------"
          echo "Device      : Pixel 5 Emulator"
          echo "Android     : $ANDROID_VERSION"
          echo "Display     : 1920x1080"
          echo "RAM         : 4 GB"
          echo "CPU Cores   : 2"
          echo ""
          echo "VNC CLIENT OPTIONS:"
          echo "-------------------------------------------------------------------"
          echo "• Windows   : TightVNC, RealVNC, UltraVNC"
          echo "• macOS     : RealVNC Viewer, Screen Sharing"
          echo "• Linux     : Remmina, TigerVNC"
          echo "• Android   : VNC Viewer (Play Store)"
          echo "• iOS       : VNC Viewer (App Store)"
          echo "• Web       : Use noVNC web client"
          echo ""
          echo "HOW TO CONNECT:"
          echo "-------------------------------------------------------------------"
          echo "1. Download VNC Viewer: https://www.realvnc.com/download/viewer/"
          echo "2. Open VNC Viewer"
          echo "3. Connect to: $TUNNEL_URL"
          echo "4. Enter password: 123456"
          echo "5. Start using Android!"
          echo ""
          echo "Session Duration: ${{ github.event.inputs.duration }}"
          echo "═══════════════════════════════════════════════════════════════════"
          echo ""

      - name: Keep Session Alive
        run: |
          case "${{ github.event.inputs.duration }}" in
            "1h") SLEEP_TIME=3600 ;;
            "3h") SLEEP_TIME=10800 ;;
            "5h40m") SLEEP_TIME=20400 ;;
            *) SLEEP_TIME=20400 ;;
          esac
          
          TUNNEL_URL=$(cat tunnel_url.txt)
          START_TIME=$(date +%s)
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            if [ $ELAPSED -ge $SLEEP_TIME ]; then
              echo "Session time limit reached"
              break
            fi
            
            HOURS=$((ELAPSED / 3600))
            MINUTES=$(((ELAPSED % 3600) / 60))
            
            ADB_STATUS=$(adb get-state 2>/dev/null || echo "offline")
            if [ "$ADB_STATUS" = "device" ]; then
              ANDROID_STATUS="Running"
            else
              ANDROID_STATUS="Offline"
            fi
            
            VNC_STATUS=$(pgrep x11vnc > /dev/null && echo "Active" || echo "Stopped")
            
            MEM_USED=$(free -h | awk 'NR==2 {print $3}')
            MEM_TOTAL=$(free -h | awk 'NR==2 {print $2}')
            CPU_LOAD=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
            
            echo ""
            echo "=========================================="
            echo "Runtime: ${HOURS}h ${MINUTES}m"
            echo "=========================================="
            echo "VNC URL     : $TUNNEL_URL"
            echo "Password    : 123456"
            echo "Android     : $ANDROID_STATUS"
            echo "VNC Server  : $VNC_STATUS"
            echo "Memory      : $MEM_USED / $MEM_TOTAL"
            echo "CPU Load    : $CPU_LOAD"
            echo "=========================================="
            echo ""
            
            sleep 300
          done
          
          echo ""
          echo "═══════════════════════════════════════════════════════════════════"
          echo "                    SESSION ENDED                                  "
          echo "═══════════════════════════════════════════════════════════════════"
          echo "Total Duration: ${{ github.event.inputs.duration }}"
          echo "Thank you for using Android Emulator VNC!"
          echo "═══════════════════════════════════════════════════════════════════"
          echo ""
