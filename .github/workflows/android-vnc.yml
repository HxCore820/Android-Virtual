name: Android Emulator VNC Remote Access

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Session Duration'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'
      android_version:
        description: 'Android Version'
        required: false
        default: '11.0'
        type: choice
        options:
        - '9.0'
        - '10.0'
        - '11.0'
        - '12.0'

jobs:
  Android-VNC:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Khởi tạo hệ thống
        run: |
          sudo apt-get update -qq > /dev/null 2>&1
          sudo apt-get install -y -qq wget curl tar unzip > /dev/null 2>&1
          echo "✅ Đã cài đặt công cụ cơ bản"
          
      - name: Cài đặt VNC Server
        run: |
          sudo apt-get install -y -qq x11vnc xvfb fluxbox > /dev/null 2>&1
          echo "✅ Đã cài đặt VNC Server"
          
      - name: Cài đặt Android SDK
        run: |
          mkdir -p $HOME/android-sdk/cmdline-tools
          cd $HOME/android-sdk/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          mv cmdline-tools latest
          
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator
          
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_HOME/emulator" >> $GITHUB_PATH
          
          echo "✅ Đã cài đặt Android SDK"
          
      - name: Thiết lập Android Emulator
        run: |
          yes | sdkmanager --licenses > /dev/null 2>&1 || true
          
          case "${{ github.event.inputs.android_version }}" in
            "9.0") API_LEVEL=28 ;;
            "10.0") API_LEVEL=29 ;;
            "11.0") API_LEVEL=30 ;;
            "12.0") API_LEVEL=31 ;;
            *) API_LEVEL=30 ;;
          esac
          
          echo "📥 Đang tải Android ${{ github.event.inputs.android_version }} (API $API_LEVEL)..."
          sdkmanager "system-images;android-${API_LEVEL};google_apis;x86_64" > /dev/null 2>&1
          sdkmanager "platform-tools" "emulator" > /dev/null 2>&1
          
          echo "no" | avdmanager create avd \
            -n android_emulator \
            -k "system-images;android-${API_LEVEL};google_apis;x86_64" \
            -d "pixel_5" > /dev/null 2>&1
          
          echo "✅ Đã tạo Android Emulator"
          
      - name: Khởi động VNC Server
        run: |
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          sleep 2
          export DISPLAY=:99
          echo "DISPLAY=:99" >> $GITHUB_ENV
          
          fluxbox > /dev/null 2>&1 &
          sleep 2
          
          x11vnc -display :99 -forever -shared -rfbport 5900 -passwd 123456 -noxdamage -bg > /dev/null 2>&1
          sleep 3
          
          echo "✅ VNC Server đã chạy"
          
      - name: Khởi động Android Emulator
        run: |
          export DISPLAY=:99
          
          echo "Đang khởi động Android Emulator..."
          
          emulator -avd android_emulator \
            -no-snapshot-save \
            -no-audio \
            -gpu swiftshader_indirect \
            -camera-back none \
            -camera-front none \
            -memory 4096 \
            -cores 2 \
            -no-window \
            -no-boot-anim \
            -accel off \
            -no-accel \
            -no-metrics \
            -verbose -show-kernel 2>&1 | grep -v "KVM\|WARNING\|metrics\|ProbeKVM\|INFO\|library_mode\|hasSufficient" &
          
          echo "⏳ Chờ Android khởi động..."
          adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done; input keyevent 82' 2>/dev/null
          
          echo "✅ Android Emulator đã sẵn sàng!"
          
      - name: Thiết lập kết nối từ xa
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          
          echo "🌐 Đang tạo đường hầm VNC..."
          ./cloudflared tunnel --url tcp://localhost:5900 > cloudflared.log 2>&1 &
          
          sleep 10
          
          TUNNEL_URL=$(grep -o 'https://[a-zA-Z0-9-]*\.trycloudflare\.com' cloudflared.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
            sleep 5
            TUNNEL_URL=$(grep -o 'https://[a-zA-Z0-9-]*\.trycloudflare\.com' cloudflared.log | head -n 1)
          fi
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "❌ Không thể tạo đường hầm"
            exit 1
          fi
          
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo "$TUNNEL_URL" > tunnel_url.txt
          echo "✅ Đường hầm đã sẵn sàng: $TUNNEL_URL"
          
      - name: Hiển thị thông tin kết nối
        run: |
          TUNNEL_URL=$(cat tunnel_url.txt)
          ANDROID_VERSION=$(adb shell getprop ro.build.version.release 2>/dev/null | tr -d '\r')
          
          echo ""
          echo "════════════════════════════════════════════════════════"
          echo "            📱 ANDROID EMULATOR ĐÃ SẴN SÀNG            "
          echo "════════════════════════════════════════════════════════"
          echo ""
          echo "🌐 KẾT NỐI VNC:"
          echo "   URL      : $TUNNEL_URL"
          echo "   Mật khẩu : 123456"
          echo ""
          echo "📱 THIẾT BỊ:"
          echo "   Máy      : Pixel 5"
          echo "   Android  : $ANDROID_VERSION"
          echo "   Màn hình : 1920x1080"
          echo "   RAM      : 4 GB"
          echo ""
          echo "💻 PHẦN MỀM VNC:"
          echo "   Tải về: https://www.realvnc.com/download/viewer/"
          echo ""
          echo "📝 CÁCH KẾT NỐI:"
          echo "   1. Mở VNC Viewer"
          echo "   2. Nhập: $TUNNEL_URL"
          echo "   3. Nhập mật khẩu: 123456"
          echo "   4. Bắt đầu sử dụng!"
          echo ""
          echo "⏱️  Thời gian: ${{ github.event.inputs.duration }}"
          echo "════════════════════════════════════════════════════════"
          echo ""

      - name: Duy trì phiên làm việc
        run: |
          case "${{ github.event.inputs.duration }}" in
            "1h") SLEEP_TIME=3600 ;;
            "3h") SLEEP_TIME=10800 ;;
            "5h40m") SLEEP_TIME=20400 ;;
            *) SLEEP_TIME=20400 ;;
          esac
          
          TUNNEL_URL=$(cat tunnel_url.txt)
          START_TIME=$(date +%s)
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            if [ $ELAPSED -ge $SLEEP_TIME ]; then
              echo "Hết thời gian sử dụng"
              break
            fi
            
            HOURS=$((ELAPSED / 3600))
            MINUTES=$(((ELAPSED % 3600) / 60))
            
            ADB_STATUS=$(adb get-state 2>/dev/null || echo "offline")
            [ "$ADB_STATUS" = "device" ] && ANDROID_STATUS="✅ Chạy" || ANDROID_STATUS="⚠️ Lỗi"
            
            VNC_STATUS=$(pgrep x11vnc > /dev/null && echo "✅ OK" || echo "❌ Lỗi")
            
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "⏰ ${HOURS}h ${MINUTES}m | 🌐 $TUNNEL_URL"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "📱 Android: $ANDROID_STATUS  |  🖥️ VNC: $VNC_STATUS"
            echo "🔐 Mật khẩu: 123456"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            
            sleep 300
          done
          
          echo ""
          echo "════════════════════════════════════════════════════════"
          echo "           ⏱️  PHIÊN LÀM VIỆC ĐÃ KẾT THÚC            "
          echo "════════════════════════════════════════════════════════"
          echo "Thời gian: ${{ github.event.inputs.duration }}"
          echo "Cảm ơn bạn đã sử dụng!"
          echo "════════════════════════════════════════════════════════"
          echo ""
